From 7ddb56e911c2a0c6da1ec36c35ec0e5949d54fdf Mon Sep 17 00:00:00 2001
From: Idderf Salem <85516773+slubbles@users.noreply.github.com>
Date: Sat, 24 Jan 2026 07:20:12 +0000
Subject: [PATCH 1/2] Fix checkout API to handle missing email in session

- Fallback to database lookup if email not in session
- Check user ID first instead of email (more reliable)
- Enhanced logging for better debugging
- Fixes 400 error 'User email not found' for existing users
---
 app/api/checkout/route.ts | 57 +++++++++++++++++----------------------
 1 file changed, 25 insertions(+), 32 deletions(-)

diff --git a/app/api/checkout/route.ts b/app/api/checkout/route.ts
index 3ef9494..85dfe2c 100644
--- a/app/api/checkout/route.ts
+++ b/app/api/checkout/route.ts
@@ -1,55 +1,48 @@
 import { NextResponse } from "next/server"
 import { auth } from "@/lib/auth"
-import { headers, cookies } from "next/headers"
-import { prisma } from "@/lib/db"
 
 export async function POST(request: Request) {
   try {
-    // Get session - NextAuth v5 with App Router
     const session = await auth()
     
-    // Debug logging
-    const headersList = await headers()
-    const cookieStore = await cookies()
-    const cookieHeader = headersList.get('cookie')
-    const sessionToken = cookieStore.get('next-auth.session-token') || cookieStore.get('__Secure-next-auth.session-token')
-    
     console.log("[Checkout] Session check:", { 
       hasSession: !!session, 
       hasUser: !!session?.user, 
-      hasId: !!session?.user?.id,
       userId: session?.user?.id,
-      sessionEmail: session?.user?.email,
-      hasCookies: !!cookieHeader,
-      hasSessionToken: !!sessionToken,
-      authSecret: !!process.env.AUTH_SECRET || !!process.env.NEXTAUTH_SECRET,
+      hasEmail: !!session?.user?.email,
+      email: session?.user?.email,
+      fullSession: JSON.stringify(session, null, 2)
     })
     
     if (!session?.user?.id) {
-      console.error("[Checkout] No session or user ID found - User may not be logged in")
       return NextResponse.json(
         { error: "Unauthorized. Please sign in." },
         { status: 401 }
       )
     }
-
-    // Fetch user email from database (same pattern as /api/auth/me)
-    // This is more reliable than trusting session.user.email with JWT strategy
-    const user = await prisma.user.findUnique({
-      where: { id: session.user.id },
-      select: { email: true }
-    })
-
-    if (!user?.email) {
-      console.error("[Checkout] User found but no email in database:", session.user.id)
-      return NextResponse.json(
-        { error: "User email not found. Please update your profile." },
-        { status: 400 }
-      )
+    
+    // If email is not in session, fetch it from database
+    let userEmail = session.user.email
+    if (!userEmail) {
+      console.log("[Checkout] Email not in session, fetching from database...")
+      const { prisma } = await import("@/lib/db")
+      const dbUser = await prisma.user.findUnique({
+        where: { id: session.user.id },
+        select: { email: true }
+      })
+      
+      if (!dbUser?.email) {
+        console.error("[Checkout] No email found in database for user:", session.user.id)
+        return NextResponse.json(
+          { error: "User email not found. Please update your profile." },
+          { status: 400 }
+        )
+      }
+      
+      userEmail = dbUser.email
+      console.log("[Checkout] Email fetched from database:", userEmail)
     }
 
-    console.log("[Checkout] User email retrieved from DB:", { email: user.email })
-
     const { plan, billingCycle } = await request.json()
     const isAnnual = billingCycle === "annual"
     
@@ -74,7 +67,7 @@ export async function POST(request: Request) {
     }
 
     // Add user email as query parameter for pre-filling
-    const urlWithEmail = `${checkoutUrl}?checkout[email]=${encodeURIComponent(user.email)}`
+    const urlWithEmail = `${checkoutUrl}?checkout[email]=${encodeURIComponent(userEmail)}`
 
     return NextResponse.json({ 
       checkoutUrl: urlWithEmail,
-- 
2.52.0

